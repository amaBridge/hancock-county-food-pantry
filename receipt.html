<!-- ============================================================
     PAGE: Receipt (receipt.html)
     Purpose:
       - Print-friendly donation receipt view.
       - Works well on iPad by providing an explicit Print button.
     Data source:
      - Reads a donation object from localStorage via ?id=... (written by index.html or donations-management.html)
============================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donation Receipt</title>
  <style>
    body { font-family: Arial, sans-serif; color: #111; background: #fff; margin: 0; padding: 0; }

    .toolbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #fff;
      border-bottom: 1px solid #ddd;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .toolbar button {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #2c3e50;
      background: #2c3e50;
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      min-width: 120px;
    }

    .toolbar button.secondary {
      background: #fff;
      color: #2c3e50;
    }

    .toolbar .hint {
      font-size: 12px;
      color: #444;
      max-width: 520px;
      text-align: center;
      line-height: 1.3;
    }

    .receipt-container {
      max-width: 420px;
      margin: 16px auto 24px auto;
      border: 2px solid #111;
      border-radius: 10px;
      padding: 20px 26px;
      background: #fff;
    }

    .logo { display: block; margin: 0 auto 14px auto; max-width: 120px; }
    h1 { text-align: center; font-size: 1.9em; margin-bottom: 0.2em; letter-spacing: 1px; }
    .subtitle { text-align: center; font-size: 1.15em; margin-bottom: 1.1em; color: #222; }

    /* Tablets: make receipt header a bit larger without changing phone sizes */
    @media (min-width: 768px) and (max-width: 1024px) {
      h1 { font-size: 2.2em; }
      .subtitle { font-size: 1.3em; }
    }

    .info-table { width: 100%; margin-bottom: 1.1em; border-collapse: collapse; }
    .info-table td { padding: 4px 0; font-size: 1em; }

    .donation-table { width: 100%; border-collapse: collapse; margin-bottom: 1.1em; }
    .donation-table th, .donation-table td { border: 1px solid #111; padding: 6px 10px; font-size: 1em; text-align: left; }
    .donation-table th { background: #eee; }

    .footer { text-align: center; font-size: 0.95em; margin-top: 1.3em; color: #222; }

    /* Hide toolbar when actually printing */
    @media print {
      .toolbar { display: none !important; }
      .receipt-container { margin-top: 24px; }
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button id="printBtn" type="button">Print</button>
    <button id="closeBtn" type="button" class="secondary">Close</button>
    <div class="hint" id="hint"></div>
  </div>

  <div class="receipt-container" id="receiptRoot">
    <!-- Filled by the inline script below -->
  </div>

  <script>
// ============================================================
// Receipt script (inlined into receipt.html)
// ============================================================
// Purpose
// - Renders a donation receipt in receipt.html.
// - Provides an explicit Print button (important for iPad Safari).
// - Optionally auto-prints on desktop when ?autoprint=1.
//
// Data source
// - Expects an id in the URL: receipt.html?id=...&autoprint=1
// - Reads localStorage[`receipt:${id}`] (written by index.html or donations-management.html)
// - Falls back to sessionStorage['receipt:last'] for refreshes
// ============================================================

function isIOSDevice() {
  const ua = navigator.userAgent || '';
  return /iPad|iPhone|iPod/.test(ua);
}

function toFixed2(value) {
  const num = Number(value);
  return Number.isFinite(num) ? num.toFixed(2) : '0.00';
}

function renderReceipt(donation) {
  const root = document.getElementById('receiptRoot');

  if (!donation) {
    root.innerHTML = '<p style="color:#b00020;">Receipt data not found.</p>';
    return;
  }

  const dateTime = donation.dateTime || '';
  const companyName = donation.companyName || '';

  root.innerHTML = `
    <img src="images/HCFP-Logo-Edited-removebg-preview.png" class="logo" alt="HCFP Logo">
    <h1>Donation Receipt</h1>
    <div class="subtitle">Hancock County Food Pantry</div>

    <table class="info-table">
      <tr><td><strong>Date & Time:</strong></td><td>${dateTime}</td></tr>
      <tr><td><strong>Company Name:</strong></td><td>${companyName}</td></tr>
    </table>

    <table class="donation-table">
      <tr><th>Category</th><th>Weight (lbs)</th></tr>
      <tr><td>Produce</td><td>${toFixed2(donation.Produce)}</td></tr>
      <tr><td>Frozen Meats</td><td>${toFixed2(donation['Frozen Meats'])}</td></tr>
      <tr><td>Misc Frozen</td><td>${toFixed2(donation['Misc Frozen'])}</td></tr>
      <tr><td>Bakery</td><td>${toFixed2(donation.Bakery)}</td></tr>
      <tr><td>Dry</td><td>${toFixed2(donation.Dry)}</td></tr>
    </table>

    <div class="footer">Thank you for your generous donation!</div>
  `;
}

document.addEventListener('DOMContentLoaded', () => {
  const printBtn = document.getElementById('printBtn');
  const closeBtn = document.getElementById('closeBtn');
  const hint = document.getElementById('hint');

  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  const autoPrint = params.get('autoprint') === '1';

  let donation = null;
  if (id) {
    try {
      const raw = localStorage.getItem(`receipt:${id}`);
      if (raw) {
        donation = JSON.parse(raw);
        // Keep a copy for refresh within this tab, then remove the keyed item.
        sessionStorage.setItem('receipt:last', raw);
        localStorage.removeItem(`receipt:${id}`);
      }
    } catch {
      donation = null;
    }
  }

  if (!donation) {
    try {
      const raw = sessionStorage.getItem('receipt:last');
      donation = raw ? JSON.parse(raw) : null;
    } catch {
      donation = null;
    }
  }

  renderReceipt(donation);

  if (isIOSDevice()) {
    hint.textContent = 'On iPad/iPhone, tap Print to open the print dialog.';
  } else {
    hint.textContent = autoPrint ? 'Opening print dialogâ€¦' : '';
  }

  printBtn.addEventListener('click', () => {
    try { window.focus(); } catch { }
    try { window.print(); } catch { }
  });

  closeBtn.addEventListener('click', () => {
    try { window.close(); } catch { }
  });

  // Auto-print for desktop browsers if requested.
  if (autoPrint && !isIOSDevice()) {
    setTimeout(() => {
      try { window.focus(); } catch { }
      try { window.print(); } catch { }
    }, 250);
  }

  // After printing, try to close (desktop popups). iOS will usually ignore this.
  window.addEventListener('afterprint', () => {
    try { window.close(); } catch { }
  });
});
  </script>
</body>
</html>
