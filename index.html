<!-- ============================================================
     PAGE: Home / Donation Entry (index.html)
     Quick-find sections:
       - TOP NAVIGATION PANE
       - HEAD / STYLES
       - BODY / APP CONTAINER
       - SCRIPTS
============================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Donation</title>
    <!-- =============================
                     HEAD / STYLES
         ============================== -->
    <style>
        /* Navigation Bar Styles */
        .navbar {
            height: 60px; /* Set a fixed height */
            padding: 0 1.2em; /* Adjust padding to maintain alignment */
            background: linear-gradient(90deg, #2c3e50 60%, #7095bd 100%);
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(44, 62, 80, 0.08);
            border-bottom: 2px solid #9dae55;
            position: relative;
            z-index: 1000;
        }
        .nav-logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            margin-right: 1em;
        }
        .nav-links {
            display: flex;
            gap: 0.5em;
            align-items: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .nav-divider {
            display: inline-block;
            width: 1px;
            height: 22px;
            background: #9dae55;
            margin: 0 0.5em;
            vertical-align: middle;
        }
        .nav-links a {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            font-size: 1.12em;
            padding: 12px 20px;
            border-radius: 10px;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .nav-links a:hover {
            background: #9dae55;
            color: #2c3e50;
            box-shadow: 0 2px 8px rgba(44, 62, 80, 0.12);
        }

        .nav-toggle {
            display: none;
            margin-left: auto;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.28);
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 28px;
            line-height: 1;
            cursor: pointer;
        }
        .nav-toggle:hover {
            background: rgba(157, 174, 85, 0.25);
            border-color: rgba(157, 174, 85, 0.8);
        }
        .nav-toggle:focus {
            outline: 2px solid #9dae55;
            outline-offset: 2px;
        }

        /* Mobile: hamburger menu */
        @media (max-width: 768px) {
            .navbar {
                height: auto;
                min-height: 60px;
                padding: 0.5rem 0.75rem;
                flex-wrap: wrap;
                justify-content: space-between;
            }

            .nav-toggle {
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

            .nav-links {
                display: none;
                flex-direction: column;
                align-items: stretch;
                gap: 0.25rem;
                width: 100%;
                padding: 0.5rem 0 0.25rem 0;
                position: static;
                left: auto;
                transform: none;
            }

            .navbar.nav-open .nav-links {
                display: flex;
            }

            .nav-links a {
                width: 100%;
                max-width: none;
                text-align: left;
                background: rgba(255, 255, 255, 0.06);
                border: 1px solid rgba(255, 255, 255, 0.18);
                box-shadow: 0 1px 0 rgba(0, 0, 0, 0.08);
            }

            .nav-links a:hover {
                background: rgba(157, 174, 85, 0.28);
                border-color: rgba(157, 174, 85, 0.9);
                color: #fff;
            }

            .nav-divider {
                display: block;
                width: 100%;
                height: 1px;
                background: rgba(255, 255, 255, 0.22);
                margin: 6px 0;
            }
        }
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            font-size: 18px;
        }
        
        .container {
            width: calc(100% - 24px);
            max-width: 600px;
            margin: 12px auto;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* iPad/tablet: let the app fill the screen more */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                max-width: 1000px;
            }

            /* Bigger header typography on tablets */
            .header-content h1 {
                font-size: 40px;
            }
            .header-content p {
                font-size: 18px;
            }
        }

        /* Desktop: let the app fill the screen more */
        @media (min-width: 1025px) {
            .container {
                max-width: 1200px;
            }
        }
        
          /* =============================
              HEADER SECTION
          ============================== */
        .header {
            background-color: #FFFFFF;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            width: auto;
            height: auto;
            max-height: 44px;
            object-fit: contain;
            margin: 0;
            padding: 0;
            display: block;
        }
        
        .header-content {
            text-align: left;
        }
        
        .header-content h1 {
            font-size: 34px;
            color: #9dae55;
            margin-bottom: 10px;
        }
        
        .header-content p {
            color: #5a7a92;
            font-size: 16px;
        }
        
          /* =============================
              COMPANY SELECTION SECTION
          ============================== */
                  /* =============================
                      ADD NEW DONOR SECTION
                  ============================== */
                  /* Uses .form-section, .input-group, .input-field, .input-field label, .input-field input */
        .form-section {
            background-color: #7095bd;
            padding: 14px;
            border-bottom: 1px solid #e0e0e0;
            margin: 0 10px 10px 10px;
            border-radius: 6px;
        }
        
        .form-section h2 {
            font-size: 18px;
            color: white;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .input-field {
            display: flex;
            flex-direction: column;
        }
        
        .input-field label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .input-field input,
        .input-field select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            min-height: 48px;
        }

        /* =============================
           COMPANY DROPDOWN + INLINE ADD
           ============================= */
        .company-row {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        /* Dropdown takes full width */
        .company-row select {
            width: 100%;
            min-width: 0;
        }

        /* When adding: keep dropdown full-width (input appears underneath) */
        .company-row.is-adding select {
            width: 100%;
        }

        /* =============================
           DONOR COMBOBOX (type-to-filter)
           ============================= */
        .donor-combobox {
            position: relative;
            width: 100%;
            /* Keep the input + clear button above the click-absorbing backdrop */
            z-index: 60;
        }
        .donor-combo-input {
            padding: 10px 12px;
            padding-right: 44px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            min-height: 48px;
            width: 100%;
            background: #fff;
        }

        .donor-combo-clear {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border-radius: 16px;
            border: 1px solid rgba(0, 0, 0, 0.18);
            background: rgba(90, 122, 146, 0.10);
            color: #2c3e50;
            font-size: 22px;
            line-height: 1;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            z-index: 65;
        }
        .donor-combo-clear:hover {
            background: rgba(90, 122, 146, 0.18);
        }
        .donor-combo-clear:focus {
            outline: 2px solid #9dae55;
            outline-offset: 2px;
        }

        .donor-combobox.has-value .donor-combo-clear {
            display: inline-flex;
        }
        .donor-combo-list {
            display: none;
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.18);
            max-height: 260px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            z-index: 70;
        }

        /* When space below is limited (keyboard), open upward instead */
        .donor-combo-list.drop-up {
            top: auto;
            bottom: calc(100% + 6px);
        }

        /* Backdrop to prevent taps/clicks landing on elements under the open dropdown */
        .donor-combo-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0);
            z-index: 45;
            pointer-events: auto;
            touch-action: none;
        }
        .donor-combo-backdrop.open {
            display: block;
        }
        .donor-combo-list.open {
            display: block;
        }

        /* =============================
           TOAST / CONFIRMATION MESSAGE
           ============================= */
        .app-toast {
            position: fixed;
            top: 76px;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            max-width: calc(100% - 24px);
            padding: 10px 14px;
            border-radius: 12px;
            background: rgba(90, 122, 146, 0.96);
            color: #fff;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
            opacity: 0;
            pointer-events: none;
            z-index: 2500;
            transition: opacity 160ms ease, transform 160ms ease;
            font-size: 14px;
            line-height: 1.25;
            text-align: center;
        }
        .app-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        @media (min-width: 768px) {
            .app-toast {
                top: 84px;
                font-size: 16px;
                padding: 12px 16px;
            }
        }
        .donor-combo-item {
            padding: 12px 12px;
            cursor: pointer;
            font-size: 16px;
            color: #2c3e50;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            user-select: none;
            touch-action: manipulation;
        }

        /* Temporary: visible build/version marker for cache debugging */
        .app-version {
            margin-top: 6px;
            font-size: 12px;
            color: rgba(90, 122, 146, 0.9);
            letter-spacing: 0.2px;
        }
        .donor-combo-item:last-child {
            border-bottom: none;
        }
        .donor-combo-item.active {
            background: #9dae55;
            color: #fff;
        }
        .donor-combo-item.muted {
            color: #6b7b88;
            cursor: default;
        }
        .company-select-hidden {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }

        .add-new-donor-inline {
            display: none;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        .add-new-donor-inline input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            min-height: 48px;
        }
        .add-new-donor-inline button {
            padding: 12px 16px;
            background-color: #9dae55;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
            min-height: 48px;
        }
        .add-new-donor-inline button:hover {
            background-color: #7fa642;
        }
        
          /* =============================
              CATEGORY SELECTION SECTION
          ============================== */
        .category-section {
            --entry-height: 84px;
            padding: 14px;
            border-bottom: 1px solid #e0e0e0;
            background-color: #7095bd;
            margin: 10px;
            border-radius: 6px;
        }
        
        .category-section h2 {
            font-size: 18px;
            color: white;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .category-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            border: 2px solid #9dae55;
            background-color: white;
            color: black;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: var(--entry-height);
        }
        
        .category-btn:hover {
            background-color: #f0f3e6;
        }
        
        .category-btn.active {
            background-color: #9dae55;
            color: white;
        }
        
          /* =============================
              WEIGHT & TEMPERATURE SECTION
          ============================== */
        .usage-section {
                        --entry-height: 84px;
            background-color: #7095bd;
            padding: 14px;
            color: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 16px;
            margin: 10px;
            border-radius: 6px;
        }
        
        .weight-container {
            display: flex;
            align-items: stretch;
            gap: 14px;
            width: 100%;
        }
        
        .usage-item {
            text-align: right;
            flex: 1 1 0;
            min-width: 0;
        }

        .usage-value-wrap {
            position: relative;
            width: 100%;
            max-width: none;
            margin-left: 0;
            flex: 1 1 auto;
            height: var(--entry-height);
            background-color: #5a7a92;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .usage-value {
            font-size: 40px;
            font-weight: bold;
            background-color: transparent;
            height: 100%;
            padding: 14px 14px 26px 14px; /* extra bottom space for the in-box labels */
            border-radius: 0;
            margin-bottom: 0;
            font-family: 'Courier New', monospace;
            text-align: right;
            align-self: center;
            width: 100%;
            transition: max-width 0.3s, flex 0.3s;
            border: none;
            color: #fff;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        /* Category label shown inside the number box (bottom-left) */
        #categoryLabel {
            position: absolute;
            left: 14px;
            bottom: 8px;
            margin: 0;
            text-align: left;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            pointer-events: none;
            line-height: 1;
            z-index: 2;
        }

        /* Units label shown inside the number box (bottom-right) */
        #poundsLabel {
            position: absolute;
            right: 14px;
            bottom: 8px;
            margin: 0;
            text-align: right;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.75);
            pointer-events: none;
            line-height: 1;
            z-index: 2;
        }
        
        .usage-value.expand {
            max-width: 100%;
            flex: 1 1 auto;
        }
        
        .usage-label {
            font-size: 14px;
            text-align: right;
            margin: 2px;
        }
        
        .temperature-input {
            display: none;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 18px;
            background-color: white;
            color: #333;
            text-align: right;
            min-width: 80px;
            align-self: center;
            height: var(--entry-height);
            flex: 0.9;
        }
        
        .temperature-input.show {
            display: block;
        }
        
        .log-weight-btn {
            padding: 12px 16px;
            background-color: #9dae55;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
            height: var(--entry-height);
            align-self: center;
            min-height: 48px;
        }
        
        .log-weight-btn:hover {
            background-color: #7fa642;
        }
        
          /* =============================
              ACTION BUTTONS SECTION
          ============================== */
        .buttons-section {
            --entry-height: 84px;
            background-color: #7095bd;
            padding: 14px;
            display: flex;
            justify-content: space-around;
            gap: 12px;
            flex-wrap: wrap;
            margin: 10px 10px 0 10px;
            border-radius: 6px;
        }
        
        .btn {
            flex: 1 1 0;
            min-width: 200px;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            white-space: normal;
            overflow-wrap: break-word;
            word-break: normal;
            line-height: 1.2;
            text-align: center;
            min-height: var(--entry-height);
        }
        
        .btn-submit {
            background-color: #9dae55;
        }
        
        .btn-submit:hover {
            background-color: #7fa642;
        }
        
        .btn-reset {
            background-color: #9dae55;
        }
        
        .btn-reset:hover {
            background-color: #7fa642;
        }
        
          /* =============================
              OUTPUT SECTION
          ============================== */
        .output-section {
            background-color: #e0e0e0;
            padding: 14px;
            /* Use flex so each row's tiles expand to fill the row (no empty-grid-column gaps) */
            display: flex;
            flex-wrap: wrap;
            justify-content: stretch;
            align-items: stretch;
            gap: 12px;
            margin: 10px;
            border-radius: 6px;
        }
        
        .output-section h2 {
            flex: 0 0 100%;
            font-size: 18px;
            color: #7095bd;
            font-weight: bold;
        }
        
        .output-item {
            background-color: #5a7a92;
            padding: 14px;
            border-radius: 10px;
            text-align: center;
            color: #00E676;
            font-family: 'Courier New', monospace;
            flex: 1 1 180px;
            min-width: 180px;
        }

        .output-value {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 4px;
            overflow-wrap: anywhere;
        }
        
        .output-label {
            font-size: 12px;
            color: #d4e4f7;
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        @media (max-width: 420px) {
            .output-section { gap: 8px; }
            .output-item { padding: 10px; }
            .output-value { font-size: 18px; }
            .output-label { font-size: 11px; }
        }
        
          /* =============================
              SUBMIT DONATION SECTION
          ============================== */
        .submit-section {
            display: flex;
            justify-content: center;
            padding: 10px;
            background-color: white;
            margin: 0 10px 10px 10px;
            border-radius: 6px;
        }
        
        .submit-donation-btn {
            padding: 14px 30px;
            background-color: #9dae55;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            min-height: 84px;
            height: 84px;
        }
        
        .submit-donation-btn:hover {
            background-color: #7fa642;
        }
        
        @media (max-width: 768px) {
          .logo {
            display: none;
          }

                                        /* Slightly shorter primary buttons on mobile, while keeping them consistent. */
                                        .category-section,
                                        .usage-section,
                                        .buttons-section {
                                            --entry-height: 60px;
                                        }

                                        .submit-donation-btn {
                                            min-height: 60px;
                                            height: 60px;
                                        }

                                        /* Keep action buttons from wrapping too early by tightening spacing first. */
                                        .buttons-section {
                                                padding: 12px;
                                                gap: 10px;
                                        }
                                        .btn {
                                                min-width: 170px;
                                                padding: 10px 12px;
                                                font-size: 15px;
                                        }

                    /* Prevent iOS Safari auto-zoom on focus (inputs <16px trigger zoom) */
                    input:not(.usage-value),
                    select,
                    textarea {
                        font-size: 16px !important;
                    }

                    /* Mobile-friendly weight/temperature layout:
                         when temperature is shown, it appears above the weight box (not overlapping it). */
                    .weight-container {
                        flex-direction: column;
                        align-items: stretch;
                    }
                    .temperature-input {
                        flex: none;
                        width: 100%;
                        min-width: 0;
                    }
                    .usage-item {
                        text-align: left;
                    }
                    .usage-value-wrap {
                        max-width: 100%;
                        margin-left: 0;
                    }
                    .log-weight-btn {
                        width: 100%;
                    }

        }

        @media (max-width: 640px) {
            /* One more step down before wrapping becomes unavoidable. */
            .buttons-section {
                padding: 10px;
                gap: 8px;
            }
            .btn {
                min-width: 150px;
                padding: 9px 10px;
                font-size: 14px;
            }
        }

                /* Touch devices (incl. iPad): prevent focus-zoom even on wider viewports */
                @media (hover: none) and (pointer: coarse) {
                    input:not(.usage-value),
                    select,
                    textarea {
                        font-size: 16px !important;
                    }

                    /* Make the whole UI easier to tap on iPad/tablets (which may render “desktop” width). */
                    body {
                        font-size: 18px;
                    }

                    .navbar {
                        padding: 0.5rem 1rem;
                        height: auto;
                        min-height: 64px;
                    }

                    .nav-links a {
                        padding: 12px 20px;
                        font-size: 1.12em;
                    }

                    .nav-toggle {
                        padding: 10px 14px;
                        font-size: 28px;
                        border-radius: 10px;
                    }

                    .container {
                        width: calc(100% - 16px);
                        margin: 8px auto;
                    }

                    .form-section,
                    .category-section,
                    .usage-section,
                    .output-section,
                    .submit-section {
                        padding: 14px;
                    }

                    .button-group {
                        gap: 12px;
                    }

                    .buttons-section {
                        padding: 14px;
                        gap: 12px;
                    }

                    .input-field input,
                    .input-field select,
                    .donor-combo-input,
                    .add-new-donor-inline input,
                    .temperature-input {
                        padding: 10px 12px;
                        font-size: 18px;
                        min-height: 48px;
                    }

                    .add-new-donor-inline button,
                    .category-btn,
                    .log-weight-btn,
                    .btn,
                    .submit-donation-btn {
                        min-height: 48px;
                        padding: 12px 16px;
                        font-size: 16px;
                        border-radius: 10px;
                    }

                    .category-btn {
                        min-height: var(--entry-height);
                    }

                    .buttons-section .btn {
                        min-height: var(--entry-height);
                    }

                    .category-btn {
                        min-width: 120px;
                    }
                }
    </style>
</head>
<body>
    <!-- =============================
                     TOP NAVIGATION PANE
         ============================== -->
    <nav class="navbar">
        <a class="nav-logo" href="index.html">
            <img src="images/HCFP-Logo-Edited-removebg-preview.png" alt="Hancock County Food Pantry Logo" class="logo" style="max-height:60px;width:auto;vertical-align:middle;margin:0;">
        </a>
        <button class="nav-toggle" type="button" aria-controls="navLinks" aria-expanded="false" aria-label="Toggle navigation menu">
            &#9776;
        </button>
        <div class="nav-links" id="navLinks">
            <a href="index.html">New Donation</a>
            <span class="nav-divider"></span>
            <a href="donor-management.html">Donor Management</a>
            <span class="nav-divider"></span>
            <a href="donations-management.html">Donations Management</a>
        </div>
    </nav>

    <!-- Prevent click-through when donor dropdown is open -->
    <div id="donorComboBackdrop" class="donor-combo-backdrop" aria-hidden="true"></div>

    <!-- Lightweight confirmation toast (e.g., new donor added) -->
    <div id="appToast" class="app-toast" role="status" aria-live="polite" aria-atomic="true"></div>

    <!-- =============================
                     BODY / APP CONTAINER
         ============================== -->

    <!-- Note: page behavior is inlined at the bottom of this file. -->
    <div class="container">
        <!-- =============================
                        HEADER
             ============================== -->
        <div class="header">
            <div class="header-content">
                <h1>Create a New Donation</h1>
                <p>For Hancock County Food Pantry</p>
            </div>
        </div>
        
        <!-- =============================
                    DONOR SELECTION
             ============================== -->
        <div class="form-section">
            <h2>Select Donor</h2>
            <div class="input-group">
                <div class="input-field">
                    <div class="company-row">
                        <div class="donor-combobox" id="donorCombobox">
                            <input type="text" id="donorComboInput" class="donor-combo-input" placeholder="Select or search donor..." autocomplete="off" spellcheck="false" aria-label="Select or search donor">
                            <button type="button" id="donorComboClear" class="donor-combo-clear" aria-label="Clear donor" title="Clear">&times;</button>
                            <div id="donorComboList" class="donor-combo-list" role="listbox" aria-label="Donor options"></div>
                        </div>

                        <select id="companySelect" class="company-select-hidden" aria-hidden="true" tabindex="-1">
                            <option value="">-- Select a Company --</option>
                            <option value="New">Add New Donor...</option>
                        </select>
                    </div>
                    <!-- Populated by updateCompanyDropdown() in the inline script -->
                </div>
            </div>
        </div>

        
        <!-- =============================
                    CATEGORY SELECTION
             ============================== -->
        <div class="category-section">
            <h2>Select Category</h2>
            <div class="button-group">
                <button class="category-btn">Produce</button>
                <button class="category-btn">Frozen Meats</button>
                <button class="category-btn">Misc Frozen</button>
                <button class="category-btn">Bakery</button>
                <button class="category-btn">Dry</button>
            </div>
        </div>
        
        <!-- =============================
                    WEIGHT ENTRY / TEMPERATURE
             ============================== -->
        <div class="usage-section">
            <div class="weight-container">
                <input type="number" id="temperatureInput" class="temperature-input" placeholder="Enter Temperature (°F)">
                <div class="usage-item">
                    <div class="usage-value-wrap">
                        <input type="number" class="usage-value" value="0.00" min="0" step="0.01">
                        <div class="usage-label" id="categoryLabel">Select Category</div>
                        <div class="usage-label" id="poundsLabel">Pounds</div>
                    </div>
                </div>
                <button class="log-weight-btn">Log Weight</button>
            </div>
        </div>
        
        <!-- =============================
                    ACTION BUTTONS
             ============================== -->
        <div class="buttons-section">
            <button class="btn btn-submit">Undo Last Logged Weight</button>
            <button class="btn btn-reset">Zero Out Selected Category</button>
            <button class="btn btn-submit">Clear Everything and Restart</button>
        </div>
        
        <!-- =============================
                    TOTALS / OUTPUT
             ============================== -->
        <div class="output-section">
            <h2>Totals</h2>
            <div class="output-item">
                <div class="output-value">0.00</div>
                <div class="output-label">Produce</div>
            </div>
            <div class="output-item">
                <div class="output-value">0.00</div>
                <div class="output-label">Frozen Meats</div>
            </div>
            <div class="output-item">
                <div class="output-value">0.00</div>
                <div class="output-label">Misc Frozen</div>
            </div>
            <div class="output-item">
                <div class="output-value">0.00</div>
                <div class="output-label">Bakery</div>
            </div>
            <div class="output-item">
                <div class="output-value">0.00</div>
                <div class="output-label">Dry</div>
            </div>
        </div>
        
        <!-- =============================
                    SUBMIT DONATION
             ============================== -->
        <div class="submit-section">
            <button class="submit-donation-btn">Submit Donation</button>
        </div>
    </div>

    <!-- =============================
                     SCRIPTS
         ============================== -->
    <script>
// ============================================================
// Home page script (inlined)
// ============================================================
// Home page logic (index.html)
//
// Quick navigation
// - Donation submit / receipt: handleSubmitDonation()
// - Company dropdown sync:     updateCompanyDropdown()
// - Donor add/select (typed):  addOrSelectDonorByName(), handleCompanyChange()
// - Category + weight logging: selectCategory(), logWeight(), totals
// - Startup wiring:            DOMContentLoaded handler at bottom
// ============================================================

// =============================
// DONATION SUBMIT LOGIC
// =============================
// Mobile Safari sometimes sends a "ghost click" after interacting with
// a <select> or an overlay list. If the UI closes under the finger, that
// click can land on an element underneath (e.g., a category button).
let suppressCategoryClicksUntil = 0;
function armCategoryClickSuppression(durationMs = 450) {
    suppressCategoryClicksUntil = Math.max(suppressCategoryClicksUntil, Date.now() + durationMs);
}
function shouldSuppressCategoryClicksNow() {
    return Date.now() < suppressCategoryClicksUntil;
}

// If the user actually taps/clicks a category button, we should not suppress it.
// Track recent pointer/touch/mouse-down on category buttons so we can distinguish
// deliberate interaction from "ghost clicks".
let lastCategoryPointerDownAt = 0;
function markCategoryPointerDown(e) {
    const btn = e?.target && e.target.closest ? e.target.closest('.category-btn') : null;
    if (!btn) return;
    lastCategoryPointerDownAt = Date.now();
}

let donorComboBackdropTimer = null;
function setDonorComboBackdropOpen(isOpen, { lingerMs = 0 } = {}) {
    const backdrop = document.getElementById('donorComboBackdrop');
    if (!backdrop) return;

    if (donorComboBackdropTimer) {
        clearTimeout(donorComboBackdropTimer);
        donorComboBackdropTimer = null;
    }

    if (isOpen) {
        backdrop.classList.add('open');
        return;
    }

    if (lingerMs > 0) {
        // Keep the backdrop around briefly to absorb any delayed/ghost clicks.
        donorComboBackdropTimer = setTimeout(() => {
            backdrop.classList.remove('open');
            donorComboBackdropTimer = null;
        }, lingerMs);
    } else {
        backdrop.classList.remove('open');
    }
}

function openReceiptPage(donation, { autoPrint = true } = {}) {
    // Writes the donation into localStorage under a short-lived key and opens receipt.html.
    // This is more reliable on iPad than trying to auto-print from injected HTML.
    const id = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
    try {
        localStorage.setItem(`receipt:${id}`, JSON.stringify(donation));
    } catch {
        // If storage is full/blocked, fall back to alert.
        alert('Unable to prepare receipt data (storage unavailable).');
        return;
    }

    const url = `receipt.html?id=${encodeURIComponent(id)}${autoPrint ? '&autoprint=1' : ''}`;
    const win = window.open(url, '_blank');
    if (!win) {
        alert('Popup blocked. Please allow popups to print receipts.');
        return;
    }
    try { win.focus(); } catch { }
}

function handleSubmitDonation() {
    const companySelect = document.getElementById('companySelect');
    let companyName = companySelect ? companySelect.value : '';
    if (!companyName) {
        alert('Please select a donor (company) before submitting.');
        try { document.getElementById('donorComboInput')?.focus(); } catch { }
        return;
    }

    // "Add New Donor..." is now handled via the combobox typed text.
    if (String(companyName).toLowerCase() === 'new') {
        const typed = String(document.getElementById('donorComboInput')?.value || '').trim();
        if (typed) {
            const createdOrSelected = addOrSelectDonorByName(typed);
            if (!createdOrSelected) return;
            companyName = companySelect ? companySelect.value : '';
        }

        if (!companyName || String(companyName).toLowerCase() === 'new') {
            alert('Please type/select a donor before submitting.');
            try { document.getElementById('donorComboInput')?.focus(); } catch { }
            return;
        }
    }
    // Get totals
    // Temperature: required when Frozen Meats is part of this donation.
    let temperature = '';
    if ((categoryTotals['Frozen Meats'] || 0) > 0) {
        const tempInput = document.getElementById('temperatureInput');
        if (tempInput) tempInput.classList.add('show');

        const tempValue = String(tempInput?.value || '').trim();
        if (!tempValue) {
            alert('Please enter a temperature for Frozen Meats.');
            try { tempInput?.focus(); } catch { }
            return;
        }

        temperature = tempValue;
    }
    const donation = {
        dateTime: new Date().toLocaleString(),
        companyName,
        Produce: categoryTotals['Produce'] || 0,
        'Frozen Meats': categoryTotals['Frozen Meats'] || 0,
        'Misc Frozen': categoryTotals['Misc Frozen'] || 0,
        Bakery: categoryTotals['Bakery'] || 0,
        Dry: categoryTotals['Dry'] || 0,
        temperature
    };
    if (!confirm('Would you like to finalize this donation?')) return;
    // Store donation
    let donations = JSON.parse(localStorage.getItem('donationsList') || '[]');
    donations.push(donation);
    localStorage.setItem('donationsList', JSON.stringify(donations));
    if (confirm('Would you like to print a receipt?')) {
                openReceiptPage(donation, { autoPrint: true });
    }
    // Redirect to Donations Management page
    window.location.href = 'donations-management.html';
}
// =============================
// DONOR DROPDOWN SYNC
// =============================
function updateCompanyDropdown() {
    // Populates the "Select Company" dropdown from localStorage('donorList').
    //
    // Notes:
    // - We preserve the placeholder option at index 0.
    // - We optionally preserve an "Add New" option for older UIs.
    // - We support legacy donor storage format (array of { name }).
    const companySelect = document.getElementById('companySelect');
    if (!companySelect) return;
    // Save current selection
    const current = companySelect.value;

    // Ensure placeholder exists at index 0
    if (companySelect.options.length === 0) {
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.text = '-- Select a Company --';
        companySelect.add(placeholder);
    }
    const placeholderOption = companySelect.options[0];

    // Detect (or create) the "Add New Donor" option.
    // Requirement: it must always be at the top of the donor list (index 1).
    let addNewOption = [...companySelect.options].find(opt =>
        (opt.value || '').toLowerCase() === 'new' ||
        (opt.text || '').toLowerCase().includes('add new')
    ) || null;

    if (!addNewOption) {
        addNewOption = document.createElement('option');
        addNewOption.value = 'New';
        addNewOption.text = 'Add New Donor...';
        companySelect.add(addNewOption);
    }

    // Move "Add New Donor" to index 1 (right under placeholder) if needed.
    if (companySelect.options.length >= 2 && companySelect.options[1] !== addNewOption) {
        companySelect.remove(addNewOption.index);
        companySelect.add(addNewOption, 1);
    }

    // Clear all options except placeholder and optional addNewOption
    for (let i = companySelect.options.length - 1; i >= 0; i--) {
        const opt = companySelect.options[i];
        if (opt === placeholderOption) continue;
        if (addNewOption && opt === addNewOption) continue;
        companySelect.remove(i);
    }

    // Load donors from storage
    let donors = [];
    try {
        const raw = JSON.parse(localStorage.getItem('donorList')) || [];
        if (Array.isArray(raw) && raw.length > 0 && typeof raw[0] === 'object' && raw[0] !== null) {
            // Legacy format: [{ name: "Acme" }, ...] -> ["Acme", ...]
            donors = raw
                .map(d => (typeof d?.name === 'string' ? d.name : ''))
                .filter(Boolean);
            localStorage.setItem('donorList', JSON.stringify(donors));
        } else {
            donors = Array.isArray(raw) ? raw : [];
        }
    } catch {
        donors = [];
    }
    // Favorites (stored as lowercased names)
    let favoriteSet = new Set();
    try {
        const favRaw = JSON.parse(localStorage.getItem('donorFavorites') || '[]');
        if (Array.isArray(favRaw)) {
            favoriteSet = new Set(favRaw.map(s => String(s || '').trim().toLowerCase()).filter(Boolean));
        }
    } catch {
        favoriteSet = new Set();
    }

    // Get sortMode from localStorage (default to 'date-desc')
    let sortMode = localStorage.getItem('donorSortMode') || 'date-desc';
    if (sortMode === 'date-desc') {
        donors = donors.slice().reverse();
    } else if (sortMode === 'date-asc') {
        donors = donors.slice();
    } else if (sortMode === 'alpha-asc') {
        donors = donors.slice().sort((a, b) => a.localeCompare(b));
    } else if (sortMode === 'alpha-desc') {
        donors = donors.slice().sort((a, b) => b.localeCompare(a));
    }
    // Pin favorites to the top, preserving the chosen sort order within each group
    const favorites = [];
    const nonFavorites = [];
    donors.forEach(name => {
        const key = String(name || '').trim().toLowerCase();
        if (favoriteSet.has(key)) favorites.push(name);
        else nonFavorites.push(name);
    });

    [...favorites, ...nonFavorites].forEach(name => {
        const normalized = String(name || '').trim();
        if (!normalized) return;

        // Don't add if already present (shouldn't happen)
        if ([...companySelect.options].some(opt => String(opt.value || '').toLowerCase() === normalized.toLowerCase())) return;

        const isFav = favoriteSet.has(normalized.toLowerCase());
        const opt = document.createElement('option');
        opt.value = normalized;
        opt.text = isFav ? `★ ${normalized}` : normalized;

        // Append donors after placeholder + "Add New Donor"
        companySelect.add(opt);
    });

    // Restore selection if possible
    if ([...companySelect.options].some(o => o.value === current)) {
        companySelect.value = current;
    } else {
        companySelect.value = '';
    }

    // Ensure the inline add-donor UI matches the current selection.
    if (typeof handleCompanyChange === 'function') {
        handleCompanyChange();
    }

    // Keep the combobox UI (if present) in sync with the backing <select>.
    if (typeof syncDonorComboboxFromSelect === 'function') {
        syncDonorComboboxFromSelect();
    }

    // If the list is open, refresh visible items.
    if (typeof renderDonorComboboxList === 'function') {
        renderDonorComboboxList();
    }
}
// =============================
// STATE VARIABLES
// =============================
let selectedCategory = '';
const categoryTotals = {
    'Produce': 0,
    'Frozen Meats': 0,
    'Misc Frozen': 0,
    'Bakery': 0,
    'Dry': 0
};
let lastMeasurement = null;

// =============================
// ACTION FUNCTIONS
// =============================
function undoLastMeasurement() {
    if (!lastMeasurement) {
        alert('No measurement to undo.');
        return;
    }
    categoryTotals[lastMeasurement.category] -= lastMeasurement.weight;
    if (categoryTotals[lastMeasurement.category] < 0) categoryTotals[lastMeasurement.category] = 0;
    updateCategoryTotals();
    lastMeasurement = null;
}

function clearCategory() {
    if (!selectedCategory || !(selectedCategory in categoryTotals)) {
        alert('Please select a category to clear.');
        return;
    }
    if (!confirm(`Clear the total for "${selectedCategory}"?`)) return;
    categoryTotals[selectedCategory] = 0;
    updateCategoryTotals();
}

function restartDonation() {
    if (!confirm('Are you sure you want to restart the donation? This will clear all entered data.')) return;
    for (const cat in categoryTotals) {
        categoryTotals[cat] = 0;
    }
    updateCategoryTotals();
    lastMeasurement = null;
    selectedCategory = '';

    // Clear any selected category button UI state
    document.querySelectorAll('.category-btn.active').forEach(btn => btn.classList.remove('active'));

    // Reset UI fields
    document.getElementById('categoryLabel').textContent = 'Select Category';
    const usageValueElem = document.querySelector('.usage-value');
    if (usageValueElem) {
        if (usageValueElem.tagName === 'INPUT') {
            usageValueElem.value = '0.00';
        } else {
            usageValueElem.textContent = '0.00';
        }
    }
    // Optionally reset company and donor fields
    const companySelect = document.getElementById('companySelect');
    if (companySelect) companySelect.value = '';
    if (typeof syncDonorComboboxFromSelect === 'function') {
        syncDonorComboboxFromSelect();
    }

    const tempInput = document.getElementById('temperatureInput');
    if (tempInput) {
        tempInput.value = '';
        tempInput.classList.remove('show');
    }

    // (Old inline add-donor UI removed)
}

function logWeight() {
    // Records a single weight entry into the selected category total.
    // Require a donor selection/add first (prevents weights being entered without a company).
    const companySelect = document.getElementById('companySelect');
    const companyName = companySelect ? companySelect.value : '';
    if (!companyName || String(companyName).toLowerCase() === 'new') {
        alert('Please select or add a donor (company) before logging weight.');
        try { document.getElementById('donorComboInput')?.focus(); } catch { }
        return;
    }

    const category = selectedCategory;
    if (!category || !(category in categoryTotals)) {
        alert('Please select a category.');
        return;
    }

    // If Frozen Meats is selected, require a temperature before logging.
    if (category === 'Frozen Meats') {
        const tempInput = document.getElementById('temperatureInput');
        if (tempInput) tempInput.classList.add('show');
        const tempValue = String(tempInput?.value || '').trim();
        if (!tempValue) {
            alert('Please enter a temperature for Frozen Meats.');
            try { tempInput?.focus(); } catch { }
            return;
        }
    }
    // Get weight value
    const usageValueElem = document.querySelector('.usage-value');
    // Support both input and div for usage-value
    let weight = 0;
    if (usageValueElem.tagName === 'INPUT') {
        weight = parseFloat(usageValueElem.value);
    } else {
        weight = parseFloat(usageValueElem.textContent);
    }
    if (isNaN(weight) || weight <= 0) {
        alert('Please enter a valid weight.');
        return;
    }
    // Add to total
    categoryTotals[category] += weight;
    lastMeasurement = { category, weight };
    updateCategoryTotals();
    // Reset usage value for next entry
    if (usageValueElem.tagName === 'INPUT') {
        usageValueElem.value = '0.00';
    } else {
        usageValueElem.textContent = '0.00';
    }
}


// =============================
// UI UPDATE FUNCTIONS
// =============================
function updateCategoryTotals() {
    // Update output section
    const outputItems = document.querySelectorAll('.output-item');
    outputItems.forEach(item => {
        const label = item.querySelector('.output-label').textContent;
        if (label in categoryTotals) {
            item.querySelector('.output-value').textContent = categoryTotals[label].toFixed(2);
        }
    });
}


// =============================
// EVENT HANDLERS
// =============================
function selectCategory(button) {
    // Remove active class from all buttons
    const allButtons = document.querySelectorAll('.category-btn');
    allButtons.forEach(btn => btn.classList.remove('active'));
    // Add active class to clicked button
    button.classList.add('active');
    // Store selected category
    selectedCategory = button.textContent;
    // Update the usage label
    document.getElementById('categoryLabel').textContent = selectedCategory;
    // Show/hide temperature input based on selection
    const tempInput = document.getElementById('temperatureInput');
    if (selectedCategory === 'Frozen Meats') {
        tempInput.classList.add('show');
    } else {
        tempInput.classList.remove('show');
    }
}


// =============================
// NAVBAR (Hamburger toggle)
// =============================
function initNavbarMenu() {
    const navbar = document.querySelector('.navbar');
    if (!navbar) return;
    const toggleButton = navbar.querySelector('.nav-toggle');
    const navLinks = navbar.querySelector('.nav-links');
    if (!toggleButton || !navLinks) return;

    function setOpen(isOpen) {
        navbar.classList.toggle('nav-open', isOpen);
        toggleButton.setAttribute('aria-expanded', String(isOpen));
    }

    toggleButton.addEventListener('click', function () {
        setOpen(!navbar.classList.contains('nav-open'));
    });

    navLinks.addEventListener('click', function (event) {
        const target = event.target;
        if (target && target.matches && target.matches('a')) {
            setOpen(false);
        }
    });

    window.addEventListener('resize', function () {
        if (window.innerWidth > 768) setOpen(false);
    });
}


function handleCompanyChange() {
    const select = document.getElementById('companySelect');
    if (!select) return;

    // Inline add-donor UI has been removed; keep the layout class in a safe state.
    const row = select.closest('.company-row');
    if (row) row.classList.remove('is-adding');
}


// =============================
// DONOR COMBOBOX (Home page)
// =============================
let donorComboOpen = false;
let donorComboActiveIndex = -1;
let donorComboItems = [];
let donorComboQuery = '';

// Touch/scroll helpers (iOS Safari can emit a click after a scroll gesture)
let donorComboLastTouchMoveAt = 0;
let donorComboSuppressClickUntil = 0;
let donorComboHasTouchEvents = false;
function donorComboTouchWasMovingRecently(windowMs = 220) {
    return Date.now() - donorComboLastTouchMoveAt < windowMs;
}

function adjustDonorComboboxDropdownPlacement() {
    const combo = document.getElementById('donorCombobox');
    const input = document.getElementById('donorComboInput');
    const list = document.getElementById('donorComboList');
    if (!combo || !input || !list) return;
    if (!donorComboOpen) return;

    // Use visualViewport so iOS keyboard reduces the measured height.
    const vv = window.visualViewport;
    const viewportHeight = vv && Number.isFinite(vv.height) ? vv.height : window.innerHeight;

    const inputRect = input.getBoundingClientRect();
    const padding = 12;
    const spaceBelow = Math.max(0, viewportHeight - inputRect.bottom - padding);
    const spaceAbove = Math.max(0, inputRect.top - padding);

    // Bigger dropdown: use a % of the *visible* viewport (shrinks automatically when keyboard shows).
    // Cap it so it never becomes absurdly large on desktop.
    const desiredMax = Math.min(560, Math.max(260, Math.floor(viewportHeight * 0.55)));
    const minUsable = 140;
    const shouldDropUp = spaceBelow < minUsable && spaceAbove > spaceBelow;

    list.classList.toggle('drop-up', shouldDropUp);

    const available = shouldDropUp ? spaceAbove : spaceBelow;
    const maxHeight = Math.max(140, Math.min(desiredMax, Math.floor(available)));
    list.style.maxHeight = `${maxHeight}px`;
}

// When a native modal (confirm/alert) returns focus to the input, it can retrigger
// our focus handler and reopen the dropdown. Use a short suppression window.
let donorComboSuppressOpenUntil = 0;
function suppressDonorComboboxAutoOpen(ms = 900) {
    donorComboSuppressOpenUntil = Date.now() + Math.max(0, Number(ms) || 0);
}

function finalizeDonorSelection({ closeDropdown = true, blurInput = true } = {}) {
    // Close the dropdown and hide the mobile keyboard by blurring the input.
    const input = document.getElementById('donorComboInput');
    if (closeDropdown && typeof closeDonorCombobox === 'function') {
        suppressDonorComboboxAutoOpen(900);
        // When a user explicitly picks/adds a donor, close immediately so the
        // full-screen backdrop doesn't block category buttons.
        closeDonorCombobox({ lingerMs: 0 });
    }
    if (blurInput && input) {
        // On mobile browsers (notably iOS), blur can be ignored if it's deferred.
        // Try immediately (within the user gesture), then retry once shortly after.
        try { input.blur(); } catch { }
        setTimeout(() => {
            try { input.blur(); } catch { }
        }, 50);
    }
}

let appToastTimer = null;

function showAppToast(message, { timeoutMs = 2400 } = {}) {
    const el = document.getElementById('appToast');
    if (!el) return;

    const text = String(message || '').trim();
    if (!text) return;

    el.textContent = text;
    el.classList.remove('show');
    // Force reflow so repeated messages animate.
    // eslint-disable-next-line no-unused-expressions
    el.offsetHeight;
    el.classList.add('show');

    if (appToastTimer) {
        clearTimeout(appToastTimer);
        appToastTimer = null;
    }

    appToastTimer = setTimeout(() => {
        try { el.classList.remove('show'); } catch { }
    }, Math.max(800, Number(timeoutMs) || 2400));
}

function normalizeDonorLabel(text) {
    return String(text || '').replace(/^★\s*/, '').trim();
}

function findExistingDonorValueByName(name) {
    const select = document.getElementById('companySelect');
    const needle = String(name || '').trim().toLowerCase();
    if (!select || !needle) return '';

    const opts = [...select.options].filter(o => String(o.value || '') !== '' && String(o.value || '').toLowerCase() !== 'new');
    const match = opts.find(o => {
        const label = normalizeDonorLabel(o.textContent || o.value);
        return String(label || '').trim().toLowerCase() === needle;
    });
    return match ? String(match.value || '') : '';
}

function addOrSelectDonorByName(name) {
    const select = document.getElementById('companySelect');
    const input = document.getElementById('donorComboInput');
    const typed = String(name || '').trim();
    if (!select) return '';
    if (!typed) {
        alert('Type a donor name first.');
        try { input?.focus(); } catch { }
        return '';
    }

    // If it already exists, just select it.
    const existingValue = findExistingDonorValueByName(typed);
    if (existingValue) {
        setSelectedDonorValue(existingValue);
        return existingValue;
    }

    // Otherwise add it to storage (case-insensitive de-dupe).
    let donors = [];
    try {
        const raw = JSON.parse(localStorage.getItem('donorList')) || [];
        if (Array.isArray(raw) && raw.length > 0 && typeof raw[0] === 'object' && raw[0] !== null) {
            donors = raw
                .map(d => (typeof d?.name === 'string' ? d.name : ''))
                .filter(Boolean);
        } else {
            donors = Array.isArray(raw) ? raw : [];
        }
    } catch {
        donors = [];
    }

    const already = donors.find(d => String(d || '').trim().toLowerCase() === typed.toLowerCase());
    const canonical = already ? String(already).trim() : typed;
    const didCreate = !already;
    if (didCreate) {
        // Prevent the confirm dialog from causing a focus-triggered re-open.
        suppressDonorComboboxAutoOpen(1200);
        const ok = confirm(`Add new donor "${canonical}"?`);
        if (!ok) {
            showAppToast('New donor was not added.');
            try { input?.focus(); } catch { }
            return '';
        }

        donors.push(canonical);
        localStorage.setItem('donorList', JSON.stringify(donors));
        updateCompanyDropdown();
    }

    setSelectedDonorValue(canonical);

    if (didCreate) {
        showAppToast(`New donor added: ${canonical}`);

        // Finish the selection on mobile (close dropdown + keyboard).
        finalizeDonorSelection({ closeDropdown: true, blurInput: true });
    }
    return canonical;
}

function syncDonorComboboxFromSelect() {
    const input = document.getElementById('donorComboInput');
    const select = document.getElementById('companySelect');
    const combo = document.getElementById('donorCombobox');
    const clearBtn = document.getElementById('donorComboClear');
    if (!input || !select) return;

    const value = select.value;
    if (!value) {
        input.value = '';
        donorComboQuery = '';
        if (combo) combo.classList.remove('has-value');
        if (clearBtn) clearBtn.setAttribute('aria-hidden', 'true');
        return;
    }

    // If the user selected "Add New Donor...", keep the combobox input empty so it
    // doesn't filter the list down to only that entry (which looks like donors disappeared).
    if (String(value).toLowerCase() === 'new') {
        input.value = '';
        donorComboQuery = '';
        if (combo) combo.classList.remove('has-value');
        if (clearBtn) clearBtn.setAttribute('aria-hidden', 'true');
        return;
    }

    const opt = [...select.options].find(o => o.value === value);
    input.value = normalizeDonorLabel(opt ? opt.textContent : value);
    donorComboQuery = '';

    if (combo) combo.classList.add('has-value');
    if (clearBtn) clearBtn.setAttribute('aria-hidden', 'false');
}

function getDonorComboboxOptionItems() {
    const select = document.getElementById('companySelect');
    const input = document.getElementById('donorComboInput');
    if (!select || !input) return [];

    const query = String(donorComboQuery || '').trim().toLowerCase();

    // Only show "Add New Donor..." if there are no other results.
    const donorOptions = [...select.options]
        .filter(opt => String(opt.value || '') !== '') // exclude placeholder
        .filter(opt => String(opt.value || '').toLowerCase() !== 'new');

    const filteredDonors = donorOptions.filter(opt => {
        if (!query) return true;
        const label = normalizeDonorLabel(opt.textContent || opt.value);
        return label.toLowerCase().includes(query);
    });

    const mappedDonors = filteredDonors.map(opt => {
        const rawText = String(opt.textContent || opt.value || '');
        const isFavorite = /^\s*★\s*/.test(rawText);
        return {
            value: opt.value,
            label: normalizeDonorLabel(rawText),
            isAddNew: false,
            isFavorite
        };
    });

    if (mappedDonors.length > 0) return mappedDonors;

    // No donor matches: show the add-new option.
    const addOpt = [...select.options].find(o => String(o.value || '').toLowerCase() === 'new');
    return [{
        value: addOpt ? addOpt.value : 'New',
        label: 'Add New Donor...',
        isAddNew: true,
        isFavorite: false
    }];
}

function openDonorCombobox() {
    donorComboOpen = true;
    // Start with no highlighted row; hover/keyboard will set it.
    donorComboActiveIndex = -1;
    // Default to showing the full list when opening.
    donorComboQuery = '';
    setDonorComboBackdropOpen(true);
    renderDonorComboboxList();
    adjustDonorComboboxDropdownPlacement();
}

function closeDonorCombobox({ lingerMs = 800 } = {}) {
    donorComboOpen = false;
    donorComboActiveIndex = -1;
    const list = document.getElementById('donorComboList');
    if (list) {
        list.classList.remove('open');
        list.classList.remove('drop-up');
        list.style.maxHeight = '';
    }

    // Linger briefly to prevent click-through on touch devices.
    setDonorComboBackdropOpen(false, { lingerMs });
}

function setSelectedDonorValue(value) {
    const select = document.getElementById('companySelect');
    if (!select) return;
    select.value = value;
    select.dispatchEvent(new Event('change', { bubbles: true }));
    donorComboQuery = '';
    syncDonorComboboxFromSelect();
}

function renderDonorComboboxList() {
    const list = document.getElementById('donorComboList');
    const input = document.getElementById('donorComboInput');
    if (!list || !input) return;

    if (!donorComboOpen) {
        list.classList.remove('open');
        return;
    }

    donorComboItems = getDonorComboboxOptionItems();

    // Clamp active index
    if (donorComboActiveIndex < -1) donorComboActiveIndex = -1;
    if (donorComboActiveIndex >= donorComboItems.length) donorComboActiveIndex = donorComboItems.length - 1;

    list.innerHTML = '';

    if (donorComboItems.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'donor-combo-item muted';
        empty.textContent = 'No matches';
        list.appendChild(empty);
        list.classList.add('open');
        return;
    }

    donorComboItems.forEach((item, idx) => {
        const row = document.createElement('div');
        row.className = 'donor-combo-item' + (idx === donorComboActiveIndex ? ' active' : '');
        row.setAttribute('role', 'option');
        row.setAttribute('aria-selected', idx === donorComboActiveIndex ? 'true' : 'false');
        const typedLabel = String(input.value || '').trim();
        row.textContent = item.isAddNew
            ? (typedLabel ? `Add New Donor: "${typedLabel}"` : 'Add New Donor...')
            : (item.isFavorite ? `★ ${item.label}` : item.label);

        // Hover behavior: move the green highlight to the row under the mouse.
        row.addEventListener('pointerenter', () => {
            if (!donorComboOpen) return;
            if (donorComboActiveIndex === idx) return;
            donorComboActiveIndex = idx;
            // Update highlight in-place (no full rerender needed)
            const children = list.children;
            for (let i = 0; i < children.length; i++) {
                const el = children[i];
                const isActive = i === donorComboActiveIndex;
                el.classList.toggle('active', isActive);
                el.setAttribute('aria-selected', isActive ? 'true' : 'false');
            }
        });

        // On touch devices, users need to be able to scroll the dropdown list.
        // Selecting on pointerdown breaks scrolling (a swipe immediately picks an item).
        const selectThisRow = (e, { bypassSuppression = false } = {}) => {
            // If the user was scrolling, ignore the tap/click.
            if (!bypassSuppression) {
                if (donorComboTouchWasMovingRecently(260)) return;
                if (Date.now() < donorComboSuppressClickUntil) return;
            }

            e?.preventDefault?.();
            e?.stopPropagation?.();

            // Short suppression window to avoid ghost clicks without making the
            // next intentional tap feel "dead".
            armCategoryClickSuppression(200);

            if (item.isAddNew) {
                const typed = String(input.value || '').trim();
                const createdOrSelected = addOrSelectDonorByName(typed);
                if (createdOrSelected) finalizeDonorSelection({ closeDropdown: true, blurInput: true });
                return;
            }

            setSelectedDonorValue(item.value);
            finalizeDonorSelection({ closeDropdown: true, blurInput: true });
        };

        // Desktop/mouse
        row.addEventListener('click', (e) => selectThisRow(e));

        // Mobile/touch: only select on touchend if the finger didn't move (scroll).
        let touchStartX = 0;
        let touchStartY = 0;
        let touchMoved = false;
        row.addEventListener('touchstart', (e) => {
            donorComboHasTouchEvents = true;
            const t = e.touches && e.touches[0];
            if (!t) return;
            touchStartX = t.clientX;
            touchStartY = t.clientY;
            touchMoved = false;
        }, { passive: true });

        row.addEventListener('touchmove', (e) => {
            const t = e.touches && e.touches[0];
            if (!t) return;
            const dx = Math.abs(t.clientX - touchStartX);
            const dy = Math.abs(t.clientY - touchStartY);
            if (dx > 8 || dy > 8) {
                touchMoved = true;
                donorComboLastTouchMoveAt = Date.now();
            }
        }, { passive: true });

        row.addEventListener('touchend', (e) => {
            if (touchMoved) return;
            // Select immediately on a tap, but suppress the synthetic click iOS may fire after.
            selectThisRow(e, { bypassSuppression: true });
            donorComboSuppressClickUntil = Date.now() + 650;
        }, { passive: false });

        // iPad "Request Desktop Website" often relies on Pointer Events instead of Touch Events.
        // Add pointer-based tap selection while preserving scroll.
        let ptrId = null;
        let ptrStartX = 0;
        let ptrStartY = 0;
        let ptrMoved = false;

        row.addEventListener('pointerdown', (e) => {
            // If the browser is already giving us touch events, avoid double-handling.
            if (donorComboHasTouchEvents) return;
            if (e.pointerType === 'mouse') return;
            ptrId = e.pointerId;
            ptrStartX = e.clientX;
            ptrStartY = e.clientY;
            ptrMoved = false;
        }, { passive: true });

        row.addEventListener('pointermove', (e) => {
            if (donorComboHasTouchEvents) return;
            if (e.pointerType === 'mouse') return;
            if (ptrId === null || e.pointerId !== ptrId) return;
            const dx = Math.abs(e.clientX - ptrStartX);
            const dy = Math.abs(e.clientY - ptrStartY);
            if (dx > 8 || dy > 8) {
                ptrMoved = true;
                donorComboLastTouchMoveAt = Date.now();
            }
        }, { passive: true });

        row.addEventListener('pointerup', (e) => {
            if (donorComboHasTouchEvents) return;
            if (e.pointerType === 'mouse') return;
            if (ptrId === null || e.pointerId !== ptrId) return;
            ptrId = null;
            if (ptrMoved) return;

            // Treat as a tap.
            selectThisRow(e, { bypassSuppression: true });
            donorComboSuppressClickUntil = Date.now() + 650;
        }, { passive: false });

        list.appendChild(row);
    });

    list.classList.add('open');
    adjustDonorComboboxDropdownPlacement();
}

function initDonorCombobox() {
    const combo = document.getElementById('donorCombobox');
    const input = document.getElementById('donorComboInput');
    const list = document.getElementById('donorComboList');
    const select = document.getElementById('companySelect');
    const backdrop = document.getElementById('donorComboBackdrop');
    const clearBtn = document.getElementById('donorComboClear');
    if (!combo || !input || !list || !select) return;

    function focusDonorInputInGesture() {
        // On iOS Safari, keyboard only appears if focus happens inside a user gesture.
        try {
            // Some browsers support the options object.
            input.focus({ preventScroll: true });
        } catch {
            try { input.focus(); } catch { }
        }
    }

    function openAndFocusFromGesture(e) {
        const target = e?.target;
        // Ignore taps on list items (they have their own selection handlers)
        if (target && target.closest && target.closest('#donorComboList')) return;
        if (clearBtn && target === clearBtn) return;

        focusDonorInputInGesture();

        // Open the dropdown immediately (still inside the gesture).
        if (Date.now() >= donorComboSuppressOpenUntil) {
            if (!donorComboOpen) openDonorCombobox();
            else adjustDonorComboboxDropdownPlacement();
        }

        // Some iOS versions will only show the keyboard if focus is called on touchend.
        // Calling it again is harmless elsewhere.
        try { input.focus({ preventScroll: true }); } catch { try { input.focus(); } catch { } }
    }

    // If the user taps the combobox container (padding/empty area), still focus the input
    // so the keyboard appears on the first tap.
    combo.addEventListener('pointerdown', openAndFocusFromGesture);
    combo.addEventListener('pointerup', openAndFocusFromGesture);
    // iOS Safari: focus must often occur on touchend to open the keyboard.
    combo.addEventListener('touchend', openAndFocusFromGesture, { passive: true });
    combo.addEventListener('click', openAndFocusFromGesture);

    // If the list scrolls (or a touchmove happens inside it), ignore any immediate clicks.
    list.addEventListener('scroll', () => {
        donorComboLastTouchMoveAt = Date.now();
    }, { passive: true });

    list.addEventListener('touchmove', () => {
        donorComboHasTouchEvents = true;
        donorComboLastTouchMoveAt = Date.now();
    }, { passive: true });

    list.addEventListener('pointermove', (e) => {
        if (e && e.pointerType && e.pointerType !== 'mouse') {
            donorComboLastTouchMoveAt = Date.now();
        }
    }, { passive: true });

    function updateClearState() {
        const hasValue = Boolean(String(input.value || '').trim()) && String(select.value || '').toLowerCase() !== 'new';
        combo.classList.toggle('has-value', hasValue);
        if (clearBtn) clearBtn.setAttribute('aria-hidden', hasValue ? 'false' : 'true');
    }

    syncDonorComboboxFromSelect();
    updateClearState();

    let lastEnterHandledAt = 0;
    function handleDonorComboEnter(e) {
        const now = Date.now();
        if (now - lastEnterHandledAt < 150) return;
        lastEnterHandledAt = now;

        e?.preventDefault?.();

        // If the user typed an exact match, select it.
        const typedLower = String(input.value || '').trim().toLowerCase();
        const candidates = getDonorComboboxOptionItems().filter(i => !i.isAddNew);
        const exact = candidates.find(i => String(i.label || '').toLowerCase() === typedLower);
        if (exact) {
            setSelectedDonorValue(exact.value);
            finalizeDonorSelection({ closeDropdown: true, blurInput: true });
            return;
        }

        if (!donorComboOpen) {
            openDonorCombobox();
            return;
        }

        // If nothing is highlighted, default to the first item on Enter.
        if (donorComboActiveIndex < 0) donorComboActiveIndex = 0;

        // If the list is empty (should be rare), just leave it open.
        const chosen = donorComboItems[donorComboActiveIndex];
        if (!chosen) return;

        if (chosen.isAddNew) {
            const createdOrSelected = addOrSelectDonorByName(String(input.value || '').trim());
            if (createdOrSelected) finalizeDonorSelection({ closeDropdown: true, blurInput: true });
            return;
        }

        setSelectedDonorValue(chosen.value);
        finalizeDonorSelection({ closeDropdown: true, blurInput: true });
    }

    input.addEventListener('focus', () => {
        if (Date.now() < donorComboSuppressOpenUntil) return;
        openDonorCombobox();
    });

    // If the input never lost focus (e.g., user clicked on a non-focusable area),
    // focusing won't fire again. Allow click/tap to reopen the dropdown.
    input.addEventListener('pointerdown', () => {
        if (Date.now() < donorComboSuppressOpenUntil) return;
        if (!donorComboOpen) openDonorCombobox();
        else adjustDonorComboboxDropdownPlacement();
    });

    input.addEventListener('input', () => {
        // When the user types, that becomes the active filter query.
        donorComboQuery = String(input.value || '');
        if (!donorComboOpen) donorComboOpen = true;
        donorComboActiveIndex = 0;
        renderDonorComboboxList();
        updateClearState();
        adjustDonorComboboxDropdownPlacement();
    });

    // Keyboard-aware resizing (iOS Safari)
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', adjustDonorComboboxDropdownPlacement);
        window.visualViewport.addEventListener('scroll', adjustDonorComboboxDropdownPlacement);
    }
    window.addEventListener('resize', adjustDonorComboboxDropdownPlacement);

    // Mobile keyboards sometimes don't emit a reliable keydown for Enter/Done.
    // beforeinput fires with insertLineBreak/insertParagraph on many browsers.
    input.addEventListener('beforeinput', (e) => {
        const type = String(e?.inputType || '');
        if (type === 'insertLineBreak' || type === 'insertParagraph') {
            handleDonorComboEnter(e);
        }
    });

    if (clearBtn) {
        const clear = (e) => {
            e.preventDefault();
            e.stopPropagation();
            armCategoryClickSuppression();

            // Clear both UI and backing <select>.
            select.value = '';
            select.dispatchEvent(new Event('change', { bubbles: true }));
            donorComboQuery = '';
            input.value = '';
            updateClearState();

            try { input.focus(); } catch { }
            openDonorCombobox();
        };
        // pointerdown avoids blur-first behavior on touch.
        clearBtn.addEventListener('pointerdown', clear);
        clearBtn.addEventListener('click', clear);
    }

    input.addEventListener('keydown', (e) => {
        const key = e.key;
        if (key === 'ArrowDown') {
            e.preventDefault();
            if (!donorComboOpen) openDonorCombobox();
            else {
                if (donorComboActiveIndex < 0) donorComboActiveIndex = 0;
                else donorComboActiveIndex = Math.min(donorComboActiveIndex + 1, donorComboItems.length - 1);
                renderDonorComboboxList();
            }
            return;
        }
        if (key === 'ArrowUp') {
            e.preventDefault();
            if (!donorComboOpen) openDonorCombobox();
            else {
                if (donorComboActiveIndex < 0) donorComboActiveIndex = Math.max(donorComboItems.length - 1, 0);
                else donorComboActiveIndex = Math.max(donorComboActiveIndex - 1, 0);
                renderDonorComboboxList();
            }
            return;
        }
        if (key === 'Escape') {
            e.preventDefault();
            closeDonorCombobox();
            return;
        }
        if (key === 'Enter') {
            handleDonorComboEnter(e);
            return;
        }
    });

    // Extra fallback: some mobile browsers only deliver Enter on keyup.
    input.addEventListener('keyup', (e) => {
        const key = e.key;
        const code = /** @type {any} */ (e).keyCode;
        if (key === 'Enter' || code === 13) {
            handleDonorComboEnter(e);
        }
    });

    // Close when clicking outside
    document.addEventListener('pointerdown', (e) => {
        if (combo.contains(e.target)) return;
        closeDonorCombobox();
    });

    // Backdrop closes the list and absorbs taps/clicks.
    if (backdrop) {
        backdrop.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeDonorCombobox();
        });
        backdrop.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });
    }

    // When the hidden select changes (e.g., after adding a donor), sync input text
    select.addEventListener('change', () => {
        syncDonorComboboxFromSelect();
        updateClearState();
    });
}


// =============================
// INITIALIZATION
// =============================
document.addEventListener('DOMContentLoaded', function() {
    initNavbarMenu();

    updateCompanyDropdown();
    // Allow donor-management page to trigger dropdown update if opened as popup
    window.updateCompanyDropdown = updateCompanyDropdown;

    // Refresh dropdown when returning to this page (incl. back/forward cache)
    window.addEventListener('pageshow', updateCompanyDropdown);
    window.addEventListener('focus', updateCompanyDropdown);
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) updateCompanyDropdown();
    });
    window.addEventListener('storage', (e) => {
        if (e.key === 'donorList' || e.key === 'donorSortMode' || e.key === 'donorFavorites') updateCompanyDropdown();
    });

    // Company select
    const select = document.getElementById('companySelect');
    if (select) {
        select.addEventListener('change', handleCompanyChange);

        // Guard against ghost-clicks after native select interactions.
        select.addEventListener('change', () => armCategoryClickSuppression(200));
        select.addEventListener('pointerdown', () => armCategoryClickSuppression(200));
    }

    // Capture-phase suppression so inline onclick handlers never fire.
    // Also mark real pointer interactions so we don't suppress intentional taps.
    document.addEventListener('pointerdown', markCategoryPointerDown, true);
    document.addEventListener('touchstart', markCategoryPointerDown, true);
    document.addEventListener('mousedown', markCategoryPointerDown, true);

    document.addEventListener('click', (e) => {
        if (!shouldSuppressCategoryClicksNow()) return;
        const targetBtn = e.target && e.target.closest ? e.target.closest('.category-btn') : null;
        if (!targetBtn) return;

        // If the user actually pressed on a category button, allow it.
        // (Ghost clicks often arrive without a preceding down event.)
        if (Date.now() - lastCategoryPointerDownAt < 800) return;

        e.preventDefault();
        e.stopImmediatePropagation();
        e.stopPropagation();
    }, true);

    // Donor combobox (type-to-filter)
    initDonorCombobox();

    // Category buttons (no inline onclick in HTML)
    document.querySelectorAll('.category-btn').forEach((btn) => {
        btn.addEventListener('click', () => selectCategory(btn));
    });

    // Log weight button
    const logBtn = document.querySelector('.log-weight-btn');
    if (logBtn) {
        logBtn.addEventListener('click', logWeight);
    }

    // Weight input: clear the default zero on focus so users can type immediately.
    const usageValueElem = document.querySelector('.usage-value');
    if (usageValueElem && usageValueElem.tagName === 'INPUT') {
        const weightInput = usageValueElem;

        const isZeroPlaceholder = (value) => {
            const v = String(value ?? '').trim();
            if (!v) return false;
            // Treat any 0 / 0.0 / 0.00 / 00.000 as placeholder.
            return /^0+(?:\.0+)?$/.test(v);
        };

        weightInput.addEventListener('focus', () => {
            if (isZeroPlaceholder(weightInput.value)) {
                weightInput.value = '';
            } else {
                // Convenience: highlight existing value for quick overwrite.
                try { weightInput.select(); } catch { }
            }
        });

        weightInput.addEventListener('blur', () => {
            const v = String(weightInput.value ?? '').trim();
            if (!v) weightInput.value = '0.00';
        });
    }
    // Action buttons
    const undoBtn = document.querySelector('.btn-submit');
    if (undoBtn) undoBtn.addEventListener('click', undoLastMeasurement);
    const clearBtn = document.querySelector('.btn-reset');
    if (clearBtn) clearBtn.addEventListener('click', clearCategory);
    const restartBtns = document.querySelectorAll('.btn-submit');
    if (restartBtns.length > 1) restartBtns[1].addEventListener('click', restartDonation);

    // Submit donation button
    const submitDonationBtn = document.querySelector('.submit-donation-btn');
    if (submitDonationBtn) {
        submitDonationBtn.addEventListener('click', handleSubmitDonation);
    }
});
    </script>
</body>
</html>
