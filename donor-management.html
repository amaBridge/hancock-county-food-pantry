<!-- ============================================================
     PAGE: Donor Management (donor-management.html)
     Quick-find sections:
       - HEAD / STYLES
       - NAVBAR
       - HEADER
       - ADD DONOR + SORT CONTROLS
       - DONOR LIST
       - SCRIPTS
============================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donor Management</title>
  <style>
    /* =============================
       HEAD / STYLES
       ============================= */

    /* ---- Base / Reset ---- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #f5f5f5; }

    /* ---- Navbar ---- */
    .navbar {
      height: 60px; /* Set a fixed height */
      padding: 0 1.2em; /* Adjust padding to maintain alignment */
      background: linear-gradient(90deg, #2c3e50 60%, #7095bd 100%);
      padding: 0.15em 1.2em 0.15em 1.2em;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 8px rgba(44, 62, 80, 0.08);
      border-bottom: 2px solid #9dae55;
      position: relative;
      z-index: 1000;
    }
    .nav-logo {
      display: flex;
      align-items: center;
      text-decoration: none;
      margin-right: 1em;
    }
    .logo {
      width: auto;
      height: auto;
      max-height: 44px;
      object-fit: contain;
      margin: 0;
      padding: 0;
      display: block;
    }
    .nav-links {
      display: flex;
      gap: 0.5em;
      align-items: center;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
    .nav-links a {
      color: #fff;
      text-decoration: none;
      font-weight: 500;
      font-size: 1.08em;
      padding: 6px 18px;
      border-radius: 4px;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    .nav-links a:hover {
      background: #9dae55;
      color: #2c3e50;
      box-shadow: 0 2px 8px rgba(44, 62, 80, 0.12);
    }
    .nav-divider {
      display: inline-block;
      width: 1px;
      height: 22px;
      background: #9dae55;
      margin: 0 0.5em;
      vertical-align: middle;
    }

    .nav-toggle {
      display: none;
      margin-left: auto;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.28);
      color: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 22px;
      line-height: 1;
      cursor: pointer;
    }
    .nav-toggle:hover {
      background: rgba(157, 174, 85, 0.25);
      border-color: rgba(157, 174, 85, 0.8);
    }
    .nav-toggle:focus {
      outline: 2px solid #9dae55;
      outline-offset: 2px;
    }

    /* Mobile: hamburger menu */
    @media (max-width: 768px) {
      .navbar {
        height: auto;
        min-height: 60px;
        padding: 0.5rem 0.75rem;
        flex-wrap: wrap;
        justify-content: space-between;
      }

      .nav-toggle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .nav-links {
        display: none;
        flex-direction: column;
        align-items: stretch;
        gap: 0.25rem;
        width: 100%;
        padding: 0.5rem 0 0.25rem 0;
        position: static;
        left: auto;
        transform: none;
      }

      .navbar.nav-open .nav-links {
        display: flex;
      }

      .nav-links a {
        width: 100%;
        max-width: none;
        text-align: left;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.08);
      }

      .nav-links a:hover {
        background: rgba(157, 174, 85, 0.28);
        border-color: rgba(157, 174, 85, 0.9);
        color: #fff;
      }

      .nav-divider {
        display: block;
        width: 100%;
        height: 1px;
        background: rgba(255, 255, 255, 0.22);
        margin: 6px 0;
      }
    }
    /* ---- Layout / Container ---- */
    .container { width: calc(100% - 24px); max-width: 600px; margin: 12px auto; background-color: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

    /* iPad/tablet: let the app fill the screen more */
    @media (min-width: 768px) and (max-width: 1024px) {
      .container { max-width: 1000px; }

      /* Bigger header typography on tablets */
      .header-content h1 { font-size: 40px; }
      .header-content p { font-size: 18px; }
    }

    /* Desktop: let the app fill the screen more */
    @media (min-width: 1025px) {
      .container { max-width: 1200px; }
    }
    .header { background-color: #fff; padding: 12px; display: flex; align-items: center; gap: 12px; }
    .logo { width: 16%; height: auto; max-height: 48px; object-fit: contain; }
    .header-content { text-align: left; }
    .header-content h1 { font-size: 34px; color: #9dae55; margin-bottom: 10px; }
    .header-content p { color: #5a7a92; font-size: 16px; }
    /* ---- Add Donor + Sort Controls ---- */
    .form-section { background-color: #7095bd; padding: 12px; border-bottom: 1px solid #e0e0e0; margin: 0 10px 10px 10px; border-radius: 6px; }
    .form-section h2 { font-size: 16px; color: white; margin-bottom: 10px; font-weight: bold; }
    .input-group { display: grid; grid-template-columns: 1fr; gap: 8px; margin-bottom: 10px; }
    .input-field { display: flex; flex-direction: column; }
    .input-field label { font-size: 12px; color: #666; margin-bottom: 5px; font-weight: bold; }
    .input-field input { padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .add-donor { display: flex; gap: 0.5em; margin: 10px 10px 0 10px; }
    .add-donor input { flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .add-donor button { padding: 6px 14px; background-color: #9dae55; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: bold; cursor: pointer; }
    .add-donor button:hover { background-color: #7fa642; }
    /* ---- Donor List ---- */
    .donor-list { background-color: #7095bd; padding: 12px; border-radius: 6px; margin: 10px; }
    .donor-list h2 { font-size: 16px; color: white; margin-bottom: 10px; font-weight: bold; }
    .donor-list ul { list-style: none; padding: 0; }
    .donor-list li { display: flex; align-items: center; justify-content: space-between; padding: 0.5em 0; border-bottom: 1px solid #e0e0e0; }
    .donor-list input[type="text"] { width: 60%; padding: 0.2em; background: transparent; border: none; font-size: 1em; color: #fff; }
    .donor-list button { margin-left: 0.5em; background-color: #5a7a92; color: #fff; border: none; border-radius: 4px; padding: 4px 10px; font-size: 13px; font-weight: bold; cursor: pointer; }
    .donor-list button:hover { background-color: #9dae55; color: #fff; }

    /* ---- Favorite (star) button ---- */
    .donor-list button.favorite-toggle {
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.25);
      color: rgba(255, 255, 255, 0.75);
      font-size: 18px;
      line-height: 1;
      padding: 4px 10px;
      min-height: 32px;
    }
    .donor-list button.favorite-toggle:hover {
      background: rgba(255, 255, 255, 0.18);
      color: rgba(255, 255, 255, 0.95);
    }
    .donor-list button.favorite-toggle.is-favorite {
      background: rgba(255, 215, 0, 0.18);
      border-color: rgba(255, 215, 0, 0.55);
      color: #ffd54a;
      text-shadow: 0 0 6px rgba(255, 213, 74, 0.45);
    }
    .donor-list button.favorite-toggle.is-favorite:hover {
      background: rgba(255, 215, 0, 0.26);
      color: #ffdf7a;
    }
    .donor-list button.favorite-toggle:focus-visible {
      outline: 2px solid rgba(255, 215, 0, 0.7);
      outline-offset: 2px;
    }
    .form-section button {
      background-color: #5a7a92;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
    }
    .form-section button:hover {
      background-color: #9dae55;
      color: #fff;
    }

    /* ---- Sort controls row (responsive) ---- */
    .sort-controls-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .sort-controls-row .spacer {
      flex: 1 1 auto;
      min-width: 0;
    }
    .favorites-toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      font-weight: bold;
      white-space: normal;
      max-width: 100%;
    }
    @media (max-width: 768px) {
      .logo {
        display: none;
      }

      /* Prevent iOS Safari auto-zoom on focus (inputs <16px trigger zoom) */
      input,
      select,
      textarea {
        font-size: 16px !important;
      }

      /* Give the favorites toggle its own line on narrow screens */
      .favorites-toggle-label {
        flex: 1 1 100%;
      }
    }

    /* Touch devices (incl. iPad): prevent focus-zoom even on wider viewports */
    @media (hover: none) and (pointer: coarse) {
      input,
      select,
      textarea {
        font-size: 16px !important;
      }
    }

    /* Tablets (iPad etc): larger tap targets + roomier layout */
    @media (hover: none) and (pointer: coarse) and (min-width: 768px) {
      body {
        font-size: 18px;
      }

      .navbar {
        padding: 0.5rem 1rem;
        height: auto;
        min-height: 64px;
      }

      .nav-links a {
        padding: 12px 20px;
        font-size: 1.12em;
      }

      .nav-toggle {
        padding: 10px 14px;
        font-size: 28px;
        border-radius: 10px;
      }

      .container {
        width: calc(100% - 16px);
        margin: 8px auto;
      }

      .form-section,
      .donor-list {
        padding: 14px;
      }

      .input-field input,
      .add-donor input {
        padding: 10px 12px;
        font-size: 18px;
        min-height: 48px;
      }

      .form-section button,
      .add-donor button,
      .donor-list button {
        min-height: 44px;
        padding: 10px 14px;
        font-size: 15px;
        border-radius: 10px;
      }

      .donor-list li {
        padding: 0.75em 0;
      }

      .donor-list input[type="text"] {
        padding: 8px 10px;
        font-size: 18px;
      }

      .donor-list button.favorite-toggle {
        min-height: 44px;
        font-size: 20px;
      }
    }

    /* Desktop: match the roomier tablet-friendly UI */
    @media (min-width: 1025px) {
      body {
        font-size: 18px;
      }

      .navbar {
        padding: 0.5rem 1rem;
        height: auto;
        min-height: 64px;
      }

      .nav-links a {
        padding: 12px 20px;
        font-size: 1.12em;
      }

      .container {
        width: calc(100% - 16px);
        margin: 8px auto;
      }

      .form-section,
      .donor-list {
        padding: 14px;
      }

      .input-field input,
      .add-donor input {
        padding: 10px 12px;
        font-size: 18px;
        min-height: 48px;
      }

      .form-section button,
      .add-donor button,
      .donor-list button {
        min-height: 44px;
        padding: 10px 14px;
        font-size: 15px;
        border-radius: 10px;
      }

      .donor-list li {
        padding: 0.75em 0;
      }

      .donor-list input[type="text"] {
        padding: 8px 10px;
        font-size: 18px;
      }

      .donor-list button.favorite-toggle {
        min-height: 44px;
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- =============================
       NAVBAR
  ============================== -->
  <nav class="navbar">
    <a class="nav-logo" href="index.html">
      <img src="images/HCFP-Logo-Edited-removebg-preview.png" alt="Hancock County Food Pantry Logo" class="logo" style="max-height:60px;width:auto;vertical-align:middle;margin:0;">
    </a>
    <button class="nav-toggle" type="button" aria-controls="navLinks" aria-expanded="false" aria-label="Toggle navigation menu">
      &#9776;
    </button>
    <div class="nav-links" id="navLinks">
      <a href="index.html">New Donation</a>
      <span class="nav-divider"></span>
      <a href="donor-management.html">Donor Management</a>
      <span class="nav-divider"></span>
      <a href="donations-management.html">Donations Management</a>
    </div>
  </nav>
  <!-- =============================
       MAIN CONTAINER
  ============================== -->
  <div class="container">

    <!-- =============================
         HEADER
    ============================== -->
    <div class="header">
      <div class="header-content">
        <h1>Manage Donors</h1>
        <p>For Hancock County Food Pantry</p>
      </div>
    </div>
    <!-- =============================
         ADD DONOR + SORT CONTROLS
    ============================== -->
    <div class="form-section">
      <div class="add-donor">
        <input type="text" id="newDonorName" placeholder="Add new donor...">
        <button id="addDonorBtn">Add</button>
      </div>
      <div class="sort-controls-row">
        <span style="color:white;font-weight:bold;">Sort:</span>
        <button id="sortDateDesc" title="Newest First">Date &#8595;</button>
        <button id="sortDateAsc" title="Oldest First">Date &#8593;</button>
        <button id="sortAlphaAsc" title="A to Z">A-Z</button>
        <button id="sortAlphaDesc" title="Z to A">Z-A</button>

        <span class="spacer"></span>

        <label class="favorites-toggle-label">
          <input type="checkbox" id="favoritesOnTopToggle">
          Favorites On Top
        </label>
      </div>
    </div>
        <!-- =============================
          DONOR LIST
        ============================== -->
        <div class="donor-list">
      <h2>Current Donors</h2>
      <ul id="donorList">
        <!-- Donor items will be populated here -->
      </ul>
    </div>
  </div>

  <!-- =============================
       SCRIPTS
  ============================== -->
  <script>
// ============================================================
// Donor management script (inlined)
// ============================================================

// ============================================================
// Donor management script (inlined into donor-management.html)
// ============================================================
// Purpose
// - Manages the donor list (create / edit / delete) on donor-management.html.
// - Persists donors in browser localStorage under key: "donorList".
// - Notifies the Home page dropdown when this page was opened as a popup
//   (via window.opener.updateCompanyDropdown()).
//
// Data model (localStorage)
// - Current: ["Acme Inc", "Jane Doe", ...]
// - Legacy:  [{"name":"Acme Inc"}, ...]  (auto-migrated)
// ============================================================

// Storage key used by Home + Donor Management
const DONOR_KEY = 'donorList';

// Storage key for favorites (stored as lowercased names for case-insensitive matching)
const FAVORITES_KEY = 'donorFavorites';

// Storage key for UI preference: favorites pinned to top of the list
const FAVORITES_ON_TOP_KEY = 'donorFavoritesOnTop';

// ----------------------------
// Storage helpers
// ----------------------------

function migrateToNameOnlyFormat() {
  // If old format (array of objects), convert to array of strings.
  // This keeps all pages in sync (Home dropdown expects name-only).
  const donors = localStorage.getItem(DONOR_KEY);
  if (donors) {
    const parsed = JSON.parse(donors);
    if (Array.isArray(parsed) && parsed.length > 0 && typeof parsed[0] === 'object' && parsed[0] !== null && 'name' in parsed[0]) {
      const migrated = parsed.map(obj => obj.name);
      localStorage.setItem(DONOR_KEY, JSON.stringify(migrated));
    }
  }
}

function getDonors() {
  // Always normalize before reading.
  migrateToNameOnlyFormat();
  const donors = localStorage.getItem(DONOR_KEY);
  return donors ? JSON.parse(donors) : [];
}

function setDonors(donors) {
  localStorage.setItem(DONOR_KEY, JSON.stringify(donors));
}

function normalizeDonorName(name) {
  return String(name || '').trim().toLowerCase();
}

function getFavoriteSet() {
  try {
    const raw = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
    if (!Array.isArray(raw)) return new Set();
    return new Set(raw.map(normalizeDonorName).filter(Boolean));
  } catch {
    return new Set();
  }
}

function setFavoriteSet(favoriteSet) {
  const arr = [...favoriteSet].filter(Boolean);
  localStorage.setItem(FAVORITES_KEY, JSON.stringify(arr));
}

function isFavorite(name) {
  const favorites = getFavoriteSet();
  return favorites.has(normalizeDonorName(name));
}

function toggleFavorite(name) {
  const key = normalizeDonorName(name);
  if (!key) return;
  const favorites = getFavoriteSet();
  if (favorites.has(key)) {
    favorites.delete(key);
  } else {
    favorites.add(key);
  }
  setFavoriteSet(favorites);
}

function renameFavorite(oldName, newName) {
  const oldKey = normalizeDonorName(oldName);
  const newKey = normalizeDonorName(newName);
  if (!oldKey || !newKey) return;

  const favorites = getFavoriteSet();
  if (!favorites.has(oldKey)) return;
  favorites.delete(oldKey);
  favorites.add(newKey);
  setFavoriteSet(favorites);
}

function removeFavorite(name) {
  const key = normalizeDonorName(name);
  if (!key) return;
  const favorites = getFavoriteSet();
  if (!favorites.has(key)) return;
  favorites.delete(key);
  setFavoriteSet(favorites);
}

function getFavoritesOnTopEnabled() {
  const raw = localStorage.getItem(FAVORITES_ON_TOP_KEY);
  // Default ON unless the user explicitly turns it off.
  if (raw === null) return true;
  return raw === 'true';
}

function setFavoritesOnTopEnabled(enabled) {
  localStorage.setItem(FAVORITES_ON_TOP_KEY, enabled ? 'true' : 'false');
}

function findDonorIndexByName(name, donors) {
  const key = String(name || '').trim().toLowerCase();
  if (!key) return -1;
  return donors.findIndex(d => String(d || '').trim().toLowerCase() === key);
}

// ----------------------------
// Rendering + sorting
// ----------------------------

let sortMode = 'date-desc'; // 'date-desc', 'date-asc', 'alpha-asc', 'alpha-desc'

function renderDonorList() {
  // Renders the list UI from storage, applying the current sort mode.
  const donorList = document.getElementById('donorList');
  donorList.innerHTML = '';
  let donors = getDonors();
  const favorites = getFavoriteSet();
  // Sorting (date-based modes assume insertion order reflects creation order)
  if (sortMode === 'date-desc') {
    donors = donors.slice().reverse();
  } else if (sortMode === 'date-asc') {
    donors = donors.slice();
  } else if (sortMode === 'alpha-asc') {
    donors = donors.slice().sort((a, b) => a.localeCompare(b));
  } else if (sortMode === 'alpha-desc') {
    donors = donors.slice().sort((a, b) => b.localeCompare(a));
  }

  // Optional: pin favorites to the top regardless of sort mode.
  // Implementation detail: we sort first, then stable-partition into favorites/non-favorites.
  // This keeps the user's selected sort order *within* each group.
  if (getFavoritesOnTopEnabled()) {
    const fav = [];
    const nonFav = [];
    donors.forEach(d => {
      if (favorites.has(normalizeDonorName(d))) fav.push(d);
      else nonFav.push(d);
    });
    donors = [...fav, ...nonFav];
  }

  donors.forEach((donor, i) => {
    const li = document.createElement('li');
    li.style.display = 'flex';
    li.style.alignItems = 'center';
    li.style.gap = '0.5em';

    // Favorite toggle (star)
    const favBtn = document.createElement('button');
    favBtn.type = 'button';
    favBtn.title = 'Favorite / Unfavorite donor';
    const favKey = normalizeDonorName(donor);
    const favOn = favorites.has(favKey);
    favBtn.className = 'favorite-toggle' + (favOn ? ' is-favorite' : '');
    favBtn.setAttribute('aria-pressed', favOn ? 'true' : 'false');
    favBtn.setAttribute('aria-label', favOn ? 'Unfavorite donor' : 'Favorite donor');
    favBtn.textContent = favOn ? '★' : '☆';
    favBtn.style.minWidth = '2.2em';
    favBtn.style.textAlign = 'center';
    favBtn.onclick = () => {
      toggleFavorite(donor);
      renderDonorList();
      if (window.opener && window.opener.updateCompanyDropdown) {
        window.opener.updateCompanyDropdown();
      }
    };
    li.appendChild(favBtn);

    // Donor name (read-only until Edit)
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = donor;
    nameInput.disabled = true;
    nameInput.style.background = 'transparent';
    nameInput.style.border = 'none';
    nameInput.style.fontSize = '1em';
    nameInput.style.flex = '1';
    li.appendChild(nameInput);

    const editBtn = document.createElement('button');
    editBtn.textContent = 'Edit';
    editBtn.onclick = () => {
      // Toggle into edit mode
      nameInput.disabled = false;
      nameInput.focus();
      editBtn.style.display = 'none';
      saveBtn.style.display = 'inline';
    };
    li.appendChild(editBtn);

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'Save';
    saveBtn.style.display = 'none';
    saveBtn.onclick = () => {
      const newName = nameInput.value.trim();
      if (!newName) {
        alert('Donor name cannot be empty.');
        return;
      }
      // Enforce case-insensitive uniqueness
      const donors = getDonors();
      const idx = findDonorIndexByName(donor, donors);
      if (idx < 0) {
        alert('Could not find this donor in storage. Please refresh and try again.');
        renderDonorList();
        return;
      }
      if (donors.some((d, j) => d.toLowerCase() === newName.toLowerCase() && j !== idx)) {
        alert('Duplicate donor name.');
        return;
      }
      const oldName = donors[idx];
      donors[idx] = newName;
      setDonors(donors);

      // If this donor was favorited, carry the favorite flag to the new name.
      renameFavorite(oldName, newName);

      renderDonorList();

      // If Home is open (typically via popup), refresh its dropdown.
      if (window.opener && window.opener.updateCompanyDropdown) {
        window.opener.updateCompanyDropdown();
      }
    };
    li.appendChild(saveBtn);

    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'Delete';
    deleteBtn.onclick = () => {
      if (confirm('Delete this donor?')) {
        const donors = getDonors();
        const idx = findDonorIndexByName(donor, donors);
        if (idx < 0) {
          alert('Could not find this donor in storage. Please refresh and try again.');
          renderDonorList();
          return;
        }
        const deletedName = donors[idx];
        donors.splice(idx, 1);
        setDonors(donors);

        // Remove from favorites if present.
        removeFavorite(deletedName);

        renderDonorList();

        // If Home is open (typically via popup), refresh its dropdown.
        if (window.opener && window.opener.updateCompanyDropdown) {
          window.opener.updateCompanyDropdown();
        }
      }
    };
    li.appendChild(deleteBtn);

    donorList.appendChild(li);
  });
}

function getDonorIndexFromList(listIdx, donors) {
  // Map the rendered list index back to the true array index.
  // Needed because edit/delete buttons operate on the rendered order.
  if (sortMode === 'date-desc') {
    return donors.length - 1 - listIdx;
  } else if (sortMode === 'date-asc') {
    return listIdx;
  } else if (sortMode === 'alpha-asc') {
    const sorted = donors.slice().sort((a, b) => a.localeCompare(b));
    return donors.indexOf(sorted[listIdx]);
  } else if (sortMode === 'alpha-desc') {
    const sorted = donors.slice().sort((a, b) => b.localeCompare(a));
    return donors.indexOf(sorted[listIdx]);
  }
  return listIdx;
}

// ----------------------------
// Page wiring (event handlers)
// ----------------------------

function initNavbarMenu() {
  const navbar = document.querySelector('.navbar');
  if (!navbar) return;
  const toggleButton = navbar.querySelector('.nav-toggle');
  const navLinks = navbar.querySelector('.nav-links');
  if (!toggleButton || !navLinks) return;

  function setOpen(isOpen) {
    navbar.classList.toggle('nav-open', isOpen);
    toggleButton.setAttribute('aria-expanded', String(isOpen));
  }

  toggleButton.addEventListener('click', function () {
    setOpen(!navbar.classList.contains('nav-open'));
  });

  navLinks.addEventListener('click', function (event) {
    const target = event.target;
    if (target && target.matches && target.matches('a')) {
      setOpen(false);
    }
  });

  window.addEventListener('resize', function () {
    if (window.innerWidth > 768) setOpen(false);
  });
}

document.addEventListener('DOMContentLoaded', () => {
  initNavbarMenu();

  // Load saved sort mode (shared with Home)
  sortMode = localStorage.getItem('donorSortMode') || sortMode;

  // Wire "Favorites On Top" toggle (persisted)
  const favoritesOnTopToggle = document.getElementById('favoritesOnTopToggle');
  if (favoritesOnTopToggle) {
    // Persist the default the first time this runs.
    if (localStorage.getItem(FAVORITES_ON_TOP_KEY) === null) {
      setFavoritesOnTopEnabled(true);
    }
    favoritesOnTopToggle.checked = getFavoritesOnTopEnabled();
    favoritesOnTopToggle.addEventListener('change', () => {
      setFavoritesOnTopEnabled(!!favoritesOnTopToggle.checked);
      renderDonorList();
    });
  }

  // Initial render
  renderDonorList();

  // Add donor
  const addDonorBtn = document.getElementById('addDonorBtn');
  addDonorBtn.onclick = () => {
    const input = document.getElementById('newDonorName');
    const name = input.value.trim();
    if (!name) {
      alert('Please enter a donor name.');
      return;
    }
    const donors = getDonors();
    if (donors.some(d => d.toLowerCase() === name.toLowerCase())) {
      alert('That donor already exists.');
      return;
    }
    if (!confirm(`Add new donor "${name}"?`)) {
      try { input.focus(); } catch { }
      return;
    }

    donors.push(name);
    setDonors(donors);
    input.value = '';
    renderDonorList();

    // If Home is open (typically via popup), refresh its dropdown.
    if (window.opener && window.opener.updateCompanyDropdown) {
      window.opener.updateCompanyDropdown();
    }
  };

  // UX: pressing Enter in the input adds the donor
  const newDonorNameInput = document.getElementById('newDonorName');
  if (newDonorNameInput) {
    newDonorNameInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        addDonorBtn.click();
      }
    });
  }

  // Sort buttons
  document.getElementById('sortDateDesc').onclick = () => { sortMode = 'date-desc'; localStorage.setItem('donorSortMode', sortMode); renderDonorList(); };
  document.getElementById('sortDateAsc').onclick = () => { sortMode = 'date-asc'; localStorage.setItem('donorSortMode', sortMode); renderDonorList(); };
  document.getElementById('sortAlphaAsc').onclick = () => { sortMode = 'alpha-asc'; localStorage.setItem('donorSortMode', sortMode); renderDonorList(); };
  document.getElementById('sortAlphaDesc').onclick = () => { sortMode = 'alpha-desc'; localStorage.setItem('donorSortMode', sortMode); renderDonorList(); };

  // Expose a hook so other pages can call it if needed.
  window.updateCompanyDropdown = function() {
    // No-op here, but allows home page to call this if needed
  };
});
  </script>
</body>
</html>
